<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>禅道报表</title>

    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" th:href="@{layui/css/layui.css}" media="all">
</head>

<body>
<div class="layui-container" style="width: 100%; margin-bottom: 25px">
    <ul class="layui-nav layui-bg-blue">
        <li class="layui-nav-item"><a href="/report/worksummary">员工业绩统计分析</a></li>
        <li class="layui-nav-item"><a href="/report/worksumsort">员工业绩合计排名分析</a></li>
        <li class="layui-nav-item"><a href="/report/workload">员工任务负载统计分析</a></li>
    </ul>
</div>

<div class="layui-container" style="width: 100%">
    <div class="layui-fluid">
        <div class="layui-form" style="text-align: center">

            <div class="layui-form-item">
                <!--所属项目搜索选择框-->
                <div class="layui-inline">
                    <label class="layui-form-label">所属项目</label>
                    <div class="layui-input-inline">
                        <select name="project" lay-filter="search_type_select">
                            <option value="" selected>请选择</option>
                            <option th:each="pro : ${projects}" th:value="${pro.id}"
                                    th:text="${pro.name}"></option>
                        </select>
                    </div>
                </div>

                <!--任务完成人搜索选择框-->
                <div class="layui-inline">
                    <label class="layui-form-label">员工</label>
                    <div class="layui-input-inline">
                        <select name="assignedTo" lay-filter="search_type_select">
                            <option value="" selected>请选择</option>
                            <option th:each="user : ${users}" th:value="${user.account}"
                                    th:text="${user.realname}"></option>
                        </select>
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">任务状态</label>
                    <div class="layui-input-inline">
                        <select name="status" lay-filter="search_type_select">
                            <option value="" selected>所有</option>
                            <option value="wait">未开始</option>
                            <option value="doing">进行中</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <!--日期类型搜索选择框-->
                <div class="layui-inline">
                    <label class="layui-form-label">日期类型</label>
                    <div class="layui-input-inline">
                        <select name="dateType" lay-filter="search_type_select">
                            <option value="" selected>请选择</option>
                            <option value="openedDate">任务创建日期</option>
                            <option value="estStarted">预计开始日期</option>
                            <option value="deadline">预计完成日期</option>
                        </select>
                    </div>
                </div>

                <!--开始日期-->
                <div class="layui-inline">
                    <label class="layui-form-label">日期范围</label>
                    <div class="layui-input-inline">
                        <input type="text" name="start_date" id="start" lay-verify="date" placeholder="请选择开始时间"
                               autocomplete="off" class="layui-input">
                    </div>

                    <div class="layui-form-mid">~</div>

                    <div class="layui-input-inline">
                        <input type="text" name="end_date" id="end" lay-verify="date" placeholder="请选择结束时间"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>

                <!--提交按钮-->
                <div class="layui-inline">
                    <button class="layui-btn" id="search" data-type="reload">
                        <i class="layui-icon layui-icon-search"></i>
                    </button>
                </div>

            </div>
        </div>

        <hr class="layui-bg-red">

        <div class="layui-row">
            <fieldset class="layui-elem-field">
                <legend>统计</legend>
                <div class="layui-field-box">
                </div>
            </fieldset>

            <div class="layui-table-body">
                <table class="layui-table" id="workload" lay-filter="workload_filter"></table>
            </div>
        </div>

    </div>
</div>

<script type="text/javascript">
    function datedifference(sDate1, sDate2) {    //sDate1和sDate2是2006-12-18格式
        let dateObj1, dateObj2, dateSpan, iDays;
        dateObj1 = Date.parse(sDate1);
        dateObj2 = Date.parse(sDate2);
        dateSpan = dateObj2 - dateObj1;
        // dateSpan = Math.abs(dateSpan);
        // iDays = Math.floor(dateSpan / (24 * 3600 * 1000));

        if (dateSpan > 0) {
            return "<span style='color:red;'>" + sDate2 + "</span>";
        }

        return sDate2;
    }

    function delayCompare(delay) {
        if (delay < 0) {
            return "<span style='color:green;font-weight: bold'>" + parseInt(delay - 1) + "</span>";
        } else if (delay > 0) {
            return "<span style='color:red;'>" + delay + "</span>";
        }
        return "<span>" + delay + "</span>";
    }
</script>

<script type="text/html" id="status_tpl">
    {{#  if(d.status == 'wait'){ }}
    <span style="color: gray">未开始</span>
    {{#  } if(d.status == 'doing'){ }}
    <span style="color: red">进行中</span>
    {{#  } }}
</script>

<script type="text/html" id="estStarted_tpl">
    {{#  if(d.estStarted == null){ }}
    <span>0000-00-00</span>
    {{#  }else{  }}
    <span>{{d.estStarted}}</span>
    {{#  } }}
</script>

<script type="text/html" id="realStarted_tpl">
    {{#  if(d.realStarted == null){ }}
    <span>0000-00-00</span>
    {{#  }else if(d.estStarted !=null && d.realStarted != null){  }}
    {{datedifference(d.estStarted,d.realStarted)}}
    {{#  }else{ }}
    <span>{{d.realStarted}}</span>
    {{#  } }}
</script>

<script type="text/html" id="deadline_tpl">
    {{#  if(d.deadline == null){ }}
    <span>0000-00-00</span>
    {{#  }else{  }}
    <span>{{d.deadline}}</span>
    {{#  } }}
</script>

<script type="text/html" id="progress_tpl">
    <span>{{d.progress * 100}} %</span>
</script>

<script type="text/html" id="task_tpl">
    <span style="text-align: left">{{d.task}}</span>
</script>

<script type="text/html" id="delay_tpl">
    {{delayCompare(d.delay)}}
</script>

<script th:src="@{layui/layui.js}"></script>

<script type="text/javascript" th:inline="javascript">
    layui.use(['table', 'laydate'], function () {
        var $ = layui.$;
        var table = layui.table,
            laydate = layui.laydate;

        var firstDate = new Date();
        firstDate.setDate(1); //第一天

        var endDate = new Date(firstDate);
        endDate.setMonth(firstDate.getMonth() + 1);
        endDate.setDate(0);

        laydate.render({
            elem: '#start',
            format: 'yyyy/MM/dd',
            type: 'date',
            value: new Date(firstDate)
        });
        laydate.render({
            elem: '#end',
            format: 'yyyy/MM/dd',
            type: 'date',
            value: new Date(endDate)
        });

        let fields = [
            [
                {field: 'finishedBy', title: '完成者', align: 'center', width: '4%'},
                {field: 'project', title: '所属项目', align: 'center', width: '13%'},
                {field: 'taskId', title: '任务编号', align: 'center', width: '5%'},
                {field: 'storyId', title: '需求编号', align: 'center', width: '5%'},
                {field: 'task', title: '任务名称',templet: 'task_tpl'},
                {field: 'status', title: '状态', align: 'center', templet: '#status_tpl', width: '6%'},
                {field: 'estStarted', title: '预计开始日期', templet: '#estStarted_tpl', align: 'center', width: '8%'},
                {field: 'deadline', title: '预计完成日期', templet: '#deadline_tpl',align: 'center', width: '8%'},
                {field: 'realStarted', title: '实际开始日期', templet: '#realStarted_tpl',align: 'center', width: '8%'},
                {field: 'consumed', title: '耗时', align: 'center', width: '4%'},
                {field: 'left', title: '剩余', align: 'center', width: '4%'},
                {field: 'progress', title: '任务进度', align: 'center', templet: '#progress_tpl', width: '6%'},
                {field: 'delay', title: '延期(天)', templet:'#delay_tpl', align: 'center', width: '5%'},
                {field: 'estimate', title: '评估工时', align: 'center', width: '6%'}
            ]
        ];

        //方法级渲染
        table.render({
            elem: '#workload',
            url: '/report/workload.json',
            parseData: function (res) { //res 即为原始返回的数据
                return {
                    "code": res.code, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "data": res.data //解析数据列表
                };
            },
            response: {
                statusName: 'code', //规定数据状态的字段名称，默认：code
                statusCode: 200, //规定成功的状态码，默认：0
                msgName: 'msg', //规定状态信息的字段名称，默认：msg
            },
            contentType: 'application/json;charset=UTF-8',
            cols: fields,
            id: 'workload',
            // toolbar: true,
            page: false,
            method: 'post',
            where: {
                startDate: new Date(firstDate),
                endDate: new Date(endDate)
            },
            done: function (res, curr, count) {
                let data_arr = res.data;
                let taskSum = data_arr.length;
                let estimateSum = 0;
                let consumedSum = 0;
                let leftSum = 0;

                data_arr.forEach(function (value, index, array) {
                    estimateSum += value.estimate;
                    consumedSum += value.consumed;
                    leftSum += value.left;
                });

                $(".layui-row>.layui-elem-field>.layui-field-box").html("<b style='font-size: 17px'>任务总数: " + taskSum + " 任务总评估工时: " + estimateSum + " 总耗时: " + consumedSum + " 总剩余工时: " + leftSum + "</b>");
                layuiRowspan(['finishedBy', 'project'], 1);//支持数组

                var headertop = $(".layui-table-header").offset().top //获取表头到文档顶部的距离
                $(window).scroll(function () {//开始监听滚动条
                    if (headertop - $(window).scrollTop() < 0) {    //超过了
                        $(".layui-table-header").addClass('table-header-fixed')//添加样式，固定住表头
                    } else {//没超过
                        $(".layui-table-header").removeClass('table-header-fixed')//移除样式
                    }
                });
            }
        });

        let active = {
            reload: function (project, assignedTo, status, dateType, startDate, endDate) {
                table.reload('workload', {
                    url: '/report/workload.json',
                    contentType: 'application/json;charset=UTF-8',
                    method: 'post',
                    where: {
                        project: project,
                        assignedTo: assignedTo,
                        status: status,
                        dateType: dateType,
                        startDate: startDate,
                        endDate: endDate
                    },
                    // toolbar: true,
                    parseData: function (res) { //res 即为原始返回的数据
                        return {
                            "code": res.code, //解析接口状态
                            "msg": res.msg, //解析提示文本
                            "data": res.data //解析数据列表
                        };
                    },
                    response: {
                        statusName: 'code', //规定数据状态的字段名称，默认：code
                        statusCode: 200, //规定成功的状态码，默认：0
                        msgName: 'msg', //规定状态信息的字段名称，默认：msg
                    },
                    page: false,
                    cols: fields,
                    done: function (res, curr, count) {
                        layuiRowspan(['finishedBy', 'project'], 1);//支持数组

                        var headertop = $(".layui-table-header").offset().top //获取表头到文档顶部的距离
                        $(window).scroll(function () {//开始监听滚动条
                            if (headertop - $(window).scrollTop() < 0) {    //超过了
                                $(".layui-table-header").addClass('table-header-fixed')//添加样式，固定住表头
                            } else {//没超过
                                $(".layui-table-header").removeClass('table-header-fixed')//移除样式
                            }
                        });

                    }
                });
            },
        };

        $('#search').on('click', function () {
            let project = $('select[name="project"]').val();
            let assignedTo = $('select[name="assignedTo"]').val();
            let status = $('select[name="status"]').val();
            let dateType = $('select[name="dateType"]').val();
            let startDate = $('input[name="start_date"]').val();
            let endDate = $('input[name="end_date"]').val();

            let oStartDate = new Date(startDate);
            let oEndDate = new Date(endDate);

            if (startDate == "") {
                layer.msg("请选择开始日期", {icon: 5, time: 1000});
                return false;
            }

            if (endDate == "") {
                layer.msg("请选择结束日期", {icon: 5, time: 1000});
                return false;
            }

            if (oStartDate > oEndDate) {
                layer.msg("开始日期不能大于结束日期", {icon: 5, time: 1000});
                return false;
            }

            var type = $(this).data('type');
            active[type] ? active[type].call(this, project, assignedTo, status, dateType, startDate, endDate) : '';
        });

        var execRowspan = function (fieldName, index, flag) {
            // 1为不冻结的情况，左侧列为冻结的情况
            let fixedNode = index == "1" ? $(".layui-table-body")[index - 1] : (index == "3" ? $(".layui-table-fixed-r") : $(".layui-table-fixed-l"));
            // 左侧导航栏不冻结的情况
            let child = $(fixedNode).find("td");
            let childFilterArr = [];
            // 获取data-field属性为fieldName的td
            for (let i = 0; i < child.length; i++) {
                if (child[i].getAttribute("data-field") == fieldName) {
                    childFilterArr.push(child[i]);
                }
            }
            // 获取td的个数和种类
            let childFilterTextObj = {};
            for (let i = 0; i < childFilterArr.length; i++) {
                let childText = flag ? childFilterArr[i].innerHTML : childFilterArr[i].textContent;
                if (childFilterTextObj[childText] == undefined) {
                    childFilterTextObj[childText] = 1;
                } else {
                    let num = childFilterTextObj[childText];
                    childFilterTextObj[childText] = num * 1 + 1;
                }
            }
            let canRowspan = true;
            let maxNum;//以前列单元格为基础获取的最大合并数
            let finalNextIndex;//获取其下第一个不合并单元格的index
            let finalNextKey;//获取其下第一个不合并单元格的值
            for (let i = 0; i < childFilterArr.length; i++) {
                (maxNum > 9000 || !maxNum) && (maxNum = $(childFilterArr[i]).prev().attr("rowspan") && fieldName != "8" ? $(childFilterArr[i]).prev().attr("rowspan") : 9999);
                let key = flag ? childFilterArr[i].innerHTML : childFilterArr[i].textContent;//获取下一个单元格的值
                let nextIndex = i + 1;
                let tdNum = childFilterTextObj[key];
                let curNum = maxNum < tdNum ? maxNum : tdNum;
                if (canRowspan) {
                    for (let j = 1; j <= curNum && (i + j < childFilterArr.length);) {//循环获取最终合并数及finalNext的index和key
                        finalNextKey = flag ? childFilterArr[i + j].innerHTML : childFilterArr[i + j].textContent;
                        finalNextIndex = i + j;
                        if ((key != finalNextKey && curNum > 1) || maxNum == j) {
                            canRowspan = true;
                            curNum = j;
                            break;
                        }
                        j++;
                        if ((i + j) == childFilterArr.length) {
                            finalNextKey = undefined;
                            finalNextIndex = i + j;
                            break;
                        }
                    }
                    childFilterArr[i].setAttribute("rowspan", curNum);
                    if ($(childFilterArr[i]).find("div.rowspan").length > 0) {//设置td内的div.rowspan高度适应合并后的高度
                        $(childFilterArr[i]).find("div.rowspan").parent("div.layui-table-cell").addClass("rowspanParent");
                        $(childFilterArr[i]).find("div.layui-table-cell")[0].style.height = curNum * 38 - 10 + "px";
                    }
                    canRowspan = false;
                } else {
                    childFilterArr[i].style.display = "none";
                }
                if (--childFilterTextObj[key] == 0 | --maxNum == 0 | --curNum == 0 | (finalNextKey != undefined && nextIndex == finalNextIndex)) {//||(finalNextKey!=undefined&&key!=finalNextKey)
                    canRowspan = true;
                }
            }
        };

        //合并数据表格行
        var layuiRowspan = function (fieldNameTmp, index, flag) {
            let fieldName = [];
            if (typeof fieldNameTmp == "string") {
                fieldName.push(fieldNameTmp);
            } else {
                fieldName = fieldName.concat(fieldNameTmp);
            }
            for (let i = 0; i < fieldName.length; i++) {
                execRowspan(fieldName[i], index, flag);
            }
        };

    });
</script>
<style>
    .layui-table th {
        font-weight: bold;
        text-align: center;
    }

    .table-header-fixed {
        position: fixed;
        top: 0;
        z-index: 99
    }
</style>
</body>
</html>